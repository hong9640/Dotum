# # ci/cd 할때 주석 풀기!
# # 1. 스테이지 순서 정의
# stages:
#   - build
#   - test
#   - deploy

# # 2. 공통 변수 설정
# variables:
#   PRIVATE_REGISTRY: "localhost:5000"
#   IMAGE_REPO_BACKEND: "${PRIVATE_REGISTRY}/S201_backend"
#   IMAGE_SHA_BACKEND: "${IMAGE_REPO_BACKEND}:${CI_COMMIT_SHA}"
#   IMAGE_LATEST_BACKEND: "${IMAGE_REPO_BACKEND}:latest"
#   IMAGE_REPO_FRONTEND: "${PRIVATE_REGISTRY}/S201_frontend"
#   IMAGE_SHA_FRONTEND: "${IMAGE_REPO_FRONTEND}:${CI_COMMIT_SHA}"
#   IMAGE_LATEST_FRONTEND: "${IMAGE_REPO_FRONTEND}:latest"


# # 3. Build 단계: Docker 이미지를 빌드하고 Private Registry에 푸시

# build-backend:
#   stage: build
#   tags:
#     - BE
#     - master
#   script:
#     - echo "Building and pushing backend image..."
#     - docker build -t "$IMAGE_LATEST_BACKEND" -t "$IMAGE_SHA_BACKEND" -f ./backend/Dockerfile .
#     - docker push "$IMAGE_LATEST_BACKEND"
#     - docker push "$IMAGE_SHA_BACKEND"
#     - echo "Backend build finished!"
#   rules:
#     - if: "$CI_COMMIT_BRANCH == 'master' || $CI_COMMIT_BRANCH == 'BE'"
#       changes:
#         - backend/**/*
#         - .gitlab-ci.yml
#         - nginx/default.conf
#         - docker-compose.yml

# build-frontend:
#   stage: build
#   tags: 
#     - FE
#     - master
#   script:
#     # GitLab CI/CD 변수를 사용해 빌드 직전에 .env 파일 생성
#     - echo "VITE_API_BASE=${VITE_API_BASE}" > ./frontend/.env
#     - echo "VITE_WS_BASE=${VITE_WS_BASE}" >> ./frontend/.env
#     - echo "Building and pushing frontend image..."
#     - docker build -t "$IMAGE_LATEST_FRONTEND" -t "$IMAGE_SHA_FRONTEND" -f ./frontend/Dockerfile .
#     - docker push "$IMAGE_LATEST_FRONTEND"
#     - docker push "$IMAGE_SHA_FRONTEND"
#     - echo "Frontend build finished!"
#   rules:
#     - if: "$CI_COMMIT_BRANCH == 'master' || $CI_COMMIT_BRANCH == 'FE'"
#       changes:
#         - frontend/**/*
#         - .gitlab-ci.yml
#         - nginx/default.conf
#         - docker-compose.yml

# # 4. Test 단계: 자동화된 테스트 실행 (아직은 안 만들었음!)

# test-app:
#   stage: test
#   tags:
#     - BE
#     - FE
#     - master
#   script:
#     - echo "Running automated tests..."
#     # 추후 여기에 실제 테스트 코드를 실행하는 명령어를 추가할 수 있습니다.
#     # 예: pytest ./backend/tests
#     - echo "No tests configured. Skipping."
#   rules:
#     - if: "$CI_COMMIT_BRANCH == 'master' || $CI_COMMIT_BRANCH == 'BE' || $CI_COMMIT_BRANCH == 'FE'"
#       changes:
#         - backend/**/*
#         - frontend/**/*
#         - .gitlab-ci.yml
#         - nginx/default.conf
#         - docker-compose.yml


# # 5. Deploy 단계: EC2 서버에 최신 버전 자동 배포

# deploy-app:
#   stage: deploy
#   tags:
#     - BE
#     - master
#   before_script: # SSH 접속 준비
#     - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
#     - eval $(ssh-agent -s)
#     - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#     - mkdir -p ~/.ssh
#     - chmod 700 ~/.ssh
#     - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
#   script:
#     - echo "Deploying to the EC2 server..."
#     # 사용자 환경에 맞게 아래 경로를 꼭 수정해야 합니다!
#     # ec2-user@localhost -> 서버에 뜨는 경로 그대로 ex) ubuntu@localhost
#     # cd ... -> 실제 실행 경로로 꼭 수정해야 합니다!
#     - ssh ec2-user@localhost "cd /home/ec2-user/your-project-folder && docker-compose pull && docker-compose up -d --remove-orphans"
#     - echo "Deployment successful!"
#   rules:
#     - if: "$CI_COMMIT_BRANCH == 'master' || $CI_COMMIT_BRANCH == 'BE' || $CI_COMMIT_BRANCH == 'FE'"
#       changes:
#         - backend/**/*
#         - frontend/**/*
#         - .gitlab-ci.yml
#         - nginx/default.conf
#         - docker-compose.yml