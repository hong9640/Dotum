# ----------------------------------------------------------------------
# Dockerfile.dev : FastAPI 개발 환경 전용
# - 이미지 빌드는 최소화하고, 코드 변경은 실시간 반영 (--reload)
# ----------------------------------------------------------------------

FROM python:3.11-slim

# 1️⃣ 시스템 패키지 설치
# - ffmpeg: librosa, 영상 처리용
# - libsm6, libxext6: OpenCV, matplotlib 등 런타임용
# - build-essential, python3-dev: webrtcvad, pyworld 컴파일용
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ffmpeg \
        libsm6 \
        libxext6 \
        libglib2.0-0 \
        libfontconfig1 \
        build-essential \
        python3-dev \
        libfftw3-dev \
        libsndfile1-dev \
        portaudio19-dev \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# uv 설치
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 2️⃣ 작업 디렉토리 설정
WORKDIR /app

# 3️⃣ 모델 디렉토리 복사 (캐시 최적화를 위해 먼저)
COPY models ./models

# 4️⃣ Python 의존성 설치
# requirements.txt만 복사 → 캐시 최적화
COPY requirements.txt .
RUN uv pip install --system --no-cache-dir -r requirements.txt

# 5️⃣ 소스 코드 복사
COPY api ./api

# 6️⃣ 서비스 계정 키 디렉토리 생성 및 환경 변수 설정
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# 7️⃣ 포트 노출 및 FastAPI 실행 (코드 자동 리로드)
EXPOSE 8000
CMD ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
